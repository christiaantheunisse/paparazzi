<!DOCTYPE module SYSTEM "module.dtd">

<module name="of_divergence_avoidance" dir="of_avoidance">
  <doc>
    <description>This is the optical flow / divergence obstacle avoidance module written by group 2 of the
    2023 autonomous flight of micro air vehicles course.
    </description>

    <define name="OFF_CAMERA" value="front_camera|bottom_camera" description="Video device to use"/>
    <define name="OFF_FPS" value="0" description="The (maximum) frequency to run the calculations at. If zero, it will max out at the camera frame rate"/>
  </doc>
  <header>
    <file name="of_avoidance.h"/>
  </header>
  <init fun="of_avoidance_init()"/>
  <makefile target="ap">
    <file name="of_avoidance.c"/>
    <file name="opencv_optical_flow.cpp"/>
    <flag name="CXXFLAGS" value="I$(PAPARAZZI_SRC)/sw/ext/opencv_bebop/install_arm/include"/>
    
    <flag name="LDFLAGS" value="L$(PAPARAZZI_HOME)/sw/ext/opencv_bebop/install_arm/lib"/>
    <flag name="LDFLAGS" value="lopencv_world"/>
    <flag name="LDFLAGS" value="L$(PAPARAZZI_HOME)/sw/ext/opencv_bebop/install_arm/share/OpenCV/3rdparty/lib"/>
    <flag name="LDFLAGS" value="llibprotobuf"/>
    <flag name="LDFLAGS" value="llibjpeg-turbo"/>
    <flag name="LDFLAGS" value="llibpng"/>
    <flag name="LDFLAGS" value="llibtiff"/>
    <flag name="LDFLAGS" value="lzlib"/>
    <flag name="LDFLAGS" value="lquirc"/>
    <flag name="LDFLAGS" value="ltegra_hal"/>
    <flag name="LDFLAGS" value="ldl"/>
    <flag name="LDFLAGS" value="lm"/>
    <flag name="LDFLAGS" value="lpthread"/>
    <flag name="LDFLAGS" value="lrt"/>
  </makefile>
  <makefile target="nps">
    <file name="of_avoidance.c"/>
    <file name="opencv_optical_flow.cpp"/>
    
    <flag name="CXXFLAGS" value="I$(PAPARAZZI_SRC)/sw/ext/opencv_bebop/install_pc/include"/>
    
    <flag name="LDFLAGS" value="L$(PAPARAZZI_HOME)/sw/ext/opencv_bebop/install_pc/lib"/>
    <flag name="LDFLAGS" value="lopencv_world"/>
    <flag name="LDFLAGS" value="L$(PAPARAZZI_HOME)/sw/ext/opencv_bebop/install_pc/share/OpenCV/3rdparty/lib"/>
    <flag name="LDFLAGS" value="llibprotobuf"/>
    <flag name="LDFLAGS" value="lquirc"/>
    <flag name="LDFLAGS" value="L/usr/lib/x86_64-linux-gnu"/>
    <flag name="LDFLAGS" value="ljpeg"/>
    <flag name="LDFLAGS" value="lpng"/>
    <flag name="LDFLAGS" value="ltiff"/>
    <flag name="LDFLAGS" value="L/usr/lib/x86_64-linux-gnu/hdf5/serial"/>
    <flag name="LDFLAGS" value="lhdf5"/>
    <flag name="LDFLAGS" value="lpthread"/>
    <flag name="LDFLAGS" value="lsz"/>
    <flag name="LDFLAGS" value="lz"/>
    <flag name="LDFLAGS" value="ldl"/>
    <flag name="LDFLAGS" value="lm"/>
    <flag name="LDFLAGS" value="lfreetype"/>
    <flag name="LDFLAGS" value="lharfbuzz"/>
    <flag name="LDFLAGS" value="lrt"/>
  </makefile>
  <settings>
    <dl_settings name="opticalFlowAvoidance">
      <dl_setting var=param_DET_THRESHOLD min="0" step="0.05" max="2" shortname="det_thresh">
      <dl_setting var=param_RESIZE_FX min="0" step="0.01" max="1" shortname="resize_fx">
      <dl_setting var=param_RESIZE_FY min="0" step="0.01" max="1" shortname="resize_fy">
      <dl_setting var=param_OFF_PYR_SCALE min="0" step="0.05" max="1" shortname="pyr_scale">
      <dl_setting var=param_OFF_LEVELS min="1" step="1" max="10" shortname="pyr_levels">
      <dl_setting var=param_OFF_WINSIZE min="1" step="1" max="30" shortname="winsize">
      <dl_setting var=param_OFF_ITERATIONS min="1" step="1" max="15" shortname="iterations">
      <dl_setting var=param_OFF_POLY_N min="1" step="1" max="20" shortname="poly_n">
      <dl_setting var=param_OFF_POLY_SIGMA min="0" step="0.1" max="3" shortname="poly_sigma">
      <dl_setting var=param_OFF_FLAGS min="0" step="1" max="10" shortname="flags">
      <dl_setting var=param_CROP_X min="0" step="1" max="320" shortname="crop_x">
      <dl_setting var=param_CROP_Y min="0" step="1" max="240" shortname="crop_y">
      <dl_setting var=param_CROP_WIDTH min="1" step="1" max="320" shortname="crop_w">
      <dl_setting var=param_CROP_HEIGHT min="1" step="1" max="240" shortname="crop_h">
      <dl_setting var=param_FOV_ANGLE min="40" step="1" max="180" shortname="fov_angle">
      <dl_setting var=param_DIR_CHANGE_THRESHOLD min="1" step="1" max="20" shortname="dir_chng_thr">
      <dl_setting var=param_PERCENTAGE_HISTORY_IMPORTANCE min="0" step="0.01" max="1" shortname="history_frac">
      <dl_setting var=param_PREFERRED_INDEX min="0" step="1" max="4" shortname="pref_index">
      <dl_setting var=param_SIDE_PENALTY min="0" step="0.01" max="1" shortname="side_penalty">
    </dl_settings>
  </settings>
</module>
